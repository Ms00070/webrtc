<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WebRTC Streamer</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f2f2f2; }
    #log { background: #000; color: #0f0; padding: 10px; height: 200px; overflow-y: auto; font-family: monospace; }
    video { width: 300px; margin: 10px; border: 2px solid #333; }
    button { padding: 10px 20px; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>WebRTC Streamer</h2>
  <input type="file" id="fileInput" accept="video/*">
  <button id="startBtn">Start Stream</button>

  <h3>Logs</h3>
  <div id="log"></div>

  <h3>Local Video</h3>
  <video id="localVideo" autoplay controls></video>

  <h3>Remote Videos</h3>
  <div id="remoteVideos"></div>

<script>
const ws = new WebSocket("wss://webrtc-9gdy.onrender.com/"); // update if local: ws://localhost:8080
const peerId = "WebClient-" + Math.floor(Math.random()*10000);

const peerConnections = {};
const dataChannels = {};
let localStream;

function log(msg) {
  const logDiv = document.getElementById("log");
  logDiv.innerHTML += msg + "<br>";
  logDiv.scrollTop = logDiv.scrollHeight;
  console.log(msg);
}

ws.onopen = () => {
  log("Connected to signaling server");
  ws.send(JSON.stringify({ type: "register", id: peerId }));
};

ws.onmessage = async (event) => {
  if (event.data.startsWith("JOINED|")) {
    const joinedId = event.data.split("|")[1];
    log(`Client connected: ${joinedId}`);
    return;
  }
  if (event.data.startsWith("DISCONNECTED|")) {
    const leftId = event.data.split("|")[1];
    log(`Client disconnected: ${leftId}`);
    if (peerConnections[leftId]) {
      peerConnections[leftId].close();
      delete peerConnections[leftId];
    }
    const vid = document.getElementById("remote-" + leftId);
    if (vid) vid.remove();
    return;
  }

  const parts = event.data.split("|", 4);
  if (parts.length < 4) return;
  const [type, sender, target, payload] = parts;

  if (type === "OFFER" && target === peerId) {
    await handleOffer(sender, payload);
  } else if (type === "ANSWER" && target === peerId) {
    await handleAnswer(sender, payload);
  } else if (type === "CANDIDATE" && target === peerId) {
    await handleCandidate(sender, payload);
  }
};

function createPeerConnection(remotePeerId) {
  log(`Creating connection with ${remotePeerId}`);
  const pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });
  peerConnections[remotePeerId] = pc;

  // Add local tracks
  if (localStream) {
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
  }

  // ICE
  pc.onicecandidate = (event) => {
    if (event.candidate) {
      ws.send(`CANDIDATE|${peerId}|${remotePeerId}|${JSON.stringify(event.candidate)}`);
    }
  };

  // Remote track
  pc.ontrack = (event) => {
    log(`Remote stream from ${remotePeerId}`);
    let video = document.getElementById("remote-" + remotePeerId);
    if (!video) {
      video = document.createElement("video");
      video.id = "remote-" + remotePeerId;
      video.autoplay = true;
      video.controls = true;
      document.getElementById("remoteVideos").appendChild(video);
    }
    video.srcObject = event.streams[0];
  };

  // Data channel
  const dc = pc.createDataChannel("dataChannel");
  dc.onmessage = (e) => log(`Data from ${remotePeerId}: ${e.data}`);
  dataChannels[remotePeerId] = dc;

  return pc;
}

async function handleOffer(sender, payload) {
  const pc = createPeerConnection(sender);
  const offer = JSON.parse(payload);
  await pc.setRemoteDescription(new RTCSessionDescription(offer));
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  ws.send(`ANSWER|${peerId}|${sender}|${JSON.stringify(answer)}`);
}

async function handleAnswer(sender, payload) {
  const pc = peerConnections[sender];
  if (!pc) return;
  const answer = JSON.parse(payload);
  await pc.setRemoteDescription(new RTCSessionDescription(answer));
}

async function handleCandidate(sender, payload) {
  const pc = peerConnections[sender];
  if (!pc) return;
  const candidate = JSON.parse(payload);
  await pc.addIceCandidate(new RTCIceCandidate(candidate));
}

// Start stream from file
document.getElementById("startBtn").onclick = async () => {
  const file = document.getElementById("fileInput").files[0];
  if (!file) {
    log("No video file selected");
    return;
  }
  const video = document.getElementById("localVideo");
  video.src = URL.createObjectURL(file);
  await video.play();

  localStream = video.captureStream();
  log("Local stream ready");

  // Send offer to all connected peers
  for (const remotePeerId in peerConnections) {
    const pc = peerConnections[remotePeerId];
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    ws.send(`OFFER|${peerId}|${remotePeerId}|${JSON.stringify(offer)}`);
    log(`Sent OFFER to ${remotePeerId}`);
  }
};
</script>
</body>
</html>
