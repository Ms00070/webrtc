<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebRTC Multi-Peer Streaming</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; }
    video { width: 320px; height: 240px; background: #000; border: 1px solid #ccc; margin: 5px; }
    .status { border: 1px solid #ccc; padding: 10px; height: 180px; overflow-y: auto; font-family: monospace; }
  </style>
</head>
<body>
  <h1>WebRTC Multi-Peer Streaming (File â†’ Unity & Python)</h1>

  <div>
    <label>Peer ID:</label>
    <input type="text" id="peerId" value="WebClient-User1">
  </div>

  <div>
    <input type="file" id="videoFileInput" accept="video/mp4,video/webm,video/ogg">
    <button id="startStreamBtn">Start Stream</button>
  </div>

  <div>
    <h3>Local Stream</h3>
    <video id="localVideo" autoplay muted playsinline></video>
  </div>

  <div>
    <h3>Remote Streams</h3>
    <div id="remoteVideos"></div>
  </div>

  <h3>Status</h3>
  <div id="statusLog" class="status"></div>

<script>
const peerIdInput = document.getElementById('peerId');
const videoFileInput = document.getElementById('videoFileInput');
const startStreamBtn = document.getElementById('startStreamBtn');
const localVideo = document.getElementById('localVideo');
const remoteVideos = document.getElementById('remoteVideos');
const statusLog = document.getElementById('statusLog');

// WebRTC maps
const peerConnections = {};
const dataChannels = {};
let ws, peerId, localStream, fileVideo;

// Log
function log(msg, err=false) {
  const div = document.createElement('div');
  div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
  if (err) div.style.color = 'red';
  statusLog.appendChild(div);
  statusLog.scrollTop = statusLog.scrollHeight;
}

// --- WebSocket connect on page load ---
window.addEventListener('load', () => {
  peerId = peerIdInput.value.trim();
  const proto = location.protocol === 'https:' ? 'wss://' : 'ws://';
  const wsUrl = proto + location.host;
  ws = new WebSocket(wsUrl);
  ws.onopen = () => {
    log('Connected to signaling server');
    ws.send(`NEWPEER|${peerId}|ALL|New peer|0|true`);
  };
  ws.onmessage = (e) => handleSignalingMessage(e.data);
  ws.onclose = () => log('Disconnected', true);
});

// --- Start streaming selected video file ---
startStreamBtn.addEventListener('click', async () => {
  const file = videoFileInput.files[0];
  if (!file) { log('Select a video file first', true); return; }

  fileVideo = document.createElement('video');
  fileVideo.src = URL.createObjectURL(file);
  await fileVideo.play();
  localStream = fileVideo.captureStream();
  localVideo.srcObject = localStream;
  log(`Streaming file: ${file.name}`);
});

// --- Handle signaling messages ---
function handleSignalingMessage(message) {
  const [type, senderId, receiverId, content] = message.split('|');
  if (senderId === peerId) return;

  if (receiverId !== peerId && receiverId !== 'ALL') return;
  log(`Received ${type} from ${senderId}`);

  switch(type) {
    case 'NEWPEER': if (!peerConnections[senderId]) createPeerConnection(senderId); break;
    case 'OFFER': handleOffer(senderId, content); break;
    case 'ANSWER': handleAnswer(senderId, content); break;
    case 'CANDIDATE': handleCandidate(senderId, content); break;
    case 'DISPOSE': removePeer(senderId); break;
  }
}

// --- Create PeerConnection ---
function createPeerConnection(remoteId) {
  const pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
  peerConnections[remoteId] = pc;

  if (localStream) {
    localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
  }

  const dc = pc.createDataChannel('chat');
  setupDataChannel(remoteId, dc);
  dataChannels[remoteId] = dc;

  pc.onicecandidate = e => {
    if (e.candidate) {
      ws.send(`CANDIDATE|${peerId}|${remoteId}|${JSON.stringify(e.candidate)}`);
    }
  };
  pc.ontrack = e => attachRemoteStream(remoteId, e.streams[0]);
  pc.ondatachannel = e => setupDataChannel(remoteId, e.channel);

  createOffer(remoteId);
}

// --- Offers/Answers ---
async function createOffer(remoteId) {
  const pc = peerConnections[remoteId];
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  ws.send(`OFFER|${peerId}|${remoteId}|${JSON.stringify(offer)}`);
}
async function handleOffer(senderId, msg) {
  const offer = JSON.parse(msg);
  let pc = peerConnections[senderId];
  if (!pc) pc = createPeerConnection(senderId);
  await pc.setRemoteDescription(new RTCSessionDescription(offer));
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  ws.send(`ANSWER|${peerId}|${senderId}|${JSON.stringify(answer)}`);
}
async function handleAnswer(senderId, msg) {
  const answer = JSON.parse(msg);
  const pc = peerConnections[senderId];
  if (pc) await pc.setRemoteDescription(new RTCSessionDescription(answer));
}
async function handleCandidate(senderId, msg) {
  const cand = JSON.parse(msg);
  const pc = peerConnections[senderId];
  if (pc) await pc.addIceCandidate(new RTCIceCandidate(cand));
}

// --- Helpers ---
function setupDataChannel(remoteId, ch) {
  ch.onopen = () => log(`DC open with ${remoteId}`);
  ch.onmessage = e => log(`DC msg from ${remoteId}: ${e.data}`);
}
function attachRemoteStream(id, stream) {
  let v = document.getElementById('remote-'+id);
  if (!v) {
    v = document.createElement('video');
    v.id = 'remote-'+id;
    v.autoplay = true; v.playsInline = true;
    remoteVideos.appendChild(v);
  }
  v.srcObject = stream;
}
function removePeer(id) {
  log(`Peer ${id} disconnected`);
  if (peerConnections[id]) peerConnections[id].close();
  delete peerConnections[id];
  delete dataChannels[id];
  const v = document.getElementById('remote-'+id);
  if (v) v.remove();
}
</script>
</body>
</html>
