<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebRTC Multi-Peer Test</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; }
    .container { display: flex; flex-direction: column; gap: 20px; }
    .video-container { display: flex; gap: 10px; flex-wrap: wrap; }
    video { width: 320px; height: 240px; background-color: #000; border: 1px solid #ccc; }
    .control-panel { display: flex; flex-direction: column; gap: 10px; padding: 15px; border: 1px solid #ccc; border-radius: 5px; background-color: #f8f8f8; }
    button { padding: 10px; cursor: pointer; }
    .status { padding: 10px; border: 1px solid #ccc; border-radius: 5px; background-color: #f0f0f0; height: 200px; overflow-y: auto; font-family: monospace; }
  </style>
</head>
<body>
  <div class="container">
    <h1>WebRTC Multi-Peer Test</h1>

    <div class="video-container">
      <div>
        <h3>Local Video</h3>
        <video id="localVideo" autoplay muted playsinline></video>
      </div>
      <div>
        <h3>Unity Video</h3>
        <video id="UnityPeerVideo" autoplay playsinline></video>
      </div>
      <div>
        <h3>Python Video</h3>
        <video id="PythonPeerVideo" autoplay playsinline></video>
      </div>
    </div>

    <div class="control-panel">
      <div>
        <label for="peerId">Your Peer ID:</label>
        <input type="text" id="peerId" value="WebClient-User1">
      </div>

      <div>
        <h4>Stream Source</h4>
        <input type="radio" id="cameraSource" name="streamSource" value="camera" checked>
        <label for="cameraSource">Camera</label>
        <input type="radio" id="fileSource" name="streamSource" value="file">
        <label for="fileSource">Video File</label>
        <div id="fileInputContainer" style="display:none; margin-top:10px;">
          <input type="file" id="videoFileInput" accept="video/mp4,video/webm,video/ogg">
          <video id="fileVideo" style="display:none;" controls></video>
        </div>
      </div>

      <div>
        <button id="startStreamBtn">Start Stream</button>
        <button id="connectBtn" disabled>Connect</button>
        <button id="disconnectBtn" disabled>Disconnect</button>
      </div>

      <div>
        <label for="dataMessage">Send Data:</label>
        <input type="text" id="dataMessage" placeholder="Enter message">
        <button id="sendDataBtn" disabled>Send</button>
      </div>
    </div>

    <div>
      <h3>Status Log</h3>
      <div id="statusLog" class="status"></div>
    </div>
  </div>

  <script>
    const localVideo = document.getElementById('localVideo');
    const UnityVideo = document.getElementById('UnityPeerVideo');
    const PythonVideo = document.getElementById('PythonPeerVideo');
    const fileVideo = document.getElementById('fileVideo');
    const fileInputContainer = document.getElementById('fileInputContainer');
    const videoFileInput = document.getElementById('videoFileInput');
    const startStreamBtn = document.getElementById('startStreamBtn');
    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const dataMessageInput = document.getElementById('dataMessage');
    const sendDataBtn = document.getElementById('sendDataBtn');
    const peerIdInput = document.getElementById('peerId');
    const cameraSourceRadio = document.getElementById('cameraSource');
    const fileSourceRadio = document.getElementById('fileSource');
    const statusLog = document.getElementById('statusLog');

    let localStream;
    let ws;
    let peerId;

    const receivers = { unity: 'UnityPeer', python: 'PythonPeer' };
    const peerConnections = {};
    const dataChannels = {};

    function log(msg, isError=false) {
      const entry = document.createElement('div');
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      if (isError) entry.style.color = 'red';
      statusLog.appendChild(entry);
      statusLog.scrollTop = statusLog.scrollHeight;
    }

    cameraSourceRadio.addEventListener('change', () => fileInputContainer.style.display='none');
    fileSourceRadio.addEventListener('change', () => fileInputContainer.style.display='block');

    videoFileInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (file) {
        const url = URL.createObjectURL(file);
        fileVideo.src = url;
        fileVideo.onloadedmetadata = () => log(`Loaded video: ${file.name} (${Math.round(file.size/1024/1024)}MB)`);
      }
    });

    startStreamBtn.addEventListener('click', async () => {
      try {
        if (cameraSourceRadio.checked) {
          localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
          localVideo.srcObject = localStream;
          log('Camera started');
        } else {
          if (!videoFileInput.files[0]) return log('Select a video file', true);
          fileVideo.style.display='block';
          await fileVideo.play();
          localStream = fileVideo.captureStream();
          localVideo.srcObject = localStream;
          log(`Streaming video file: ${videoFileInput.files[0].name}`);
        }
        startStreamBtn.disabled = true;
        connectBtn.disabled = false;
      } catch (err) { log(`Error: ${err.message}`, true); }
    });

    connectBtn.addEventListener('click', () => {
      peerId = peerIdInput.value.trim() || `WebClient-${Date.now()}`;
      const wsUrl = 'wss://webrtc-9gdy.onrender.com/';
      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        log('Connected to signaling server');
        ws.send(`NEWPEER|${peerId}|ALL|New peer|0|true`);
        connectBtn.disabled = true;
        disconnectBtn.disabled = false;
        sendDataBtn.disabled = false;
      };

      ws.onmessage = e => handleSignalingMessage(e.data);
      ws.onclose = () => { log('Disconnected'); disconnectAll(); };
      ws.onerror = err => log(`WebSocket error: ${err.message}`, true);
    });

    disconnectBtn.addEventListener('click', () => {
      if (ws && ws.readyState === WebSocket.OPEN)
        ws.send(`DISPOSE|${peerId}|ALL|Remove peer|0|false`);
      disconnectAll();
    });

    sendDataBtn.addEventListener('click', () => {
      const msg = dataMessageInput.value.trim();
      for (const key in dataChannels)
        if (dataChannels[key]?.readyState==='open') dataChannels[key].send(msg);
      log(`Sent: ${msg}`);
      dataMessageInput.value='';
    });

    function handleSignalingMessage(message) {
      const parts = message.split('|');
      const type=parts[0], senderId=parts[1], receiverId=parts[2], msgContent=parts[3];
      if (receiverId !== peerId && receiverId!=='ALL') return;
      log(`Received ${type} from ${senderId}`);
      switch(type){
        case 'NEWPEER':
        case 'NEWPEERACK':
          Object.keys(receivers).forEach(k=>{
            if (!peerConnections[k]) createPeerConnection(k);
          });
          break;
        case 'OFFER': handleOffer(senderId, msgContent); break;
        case 'ANSWER': handleAnswer(senderId, msgContent); break;
        case 'CANDIDATE': handleCandidate(senderId, msgContent); break;
        case 'DISPOSE': log(`${senderId} disconnected`); cleanupRTC(); break;
      }
    }

    function createPeerConnection(key){
      const remoteId = receivers[key];
      const pc = new RTCPeerConnection({ iceServers:[{urls:'stun:stun.l.google.com:19302'}] });

      if (localStream) localStream.getTracks().forEach(track=>pc.addTrack(track, localStream));

      const dc = pc.createDataChannel('dataChannel');
      setupDataChannel(dc, key);
      dataChannels[key]=dc;

      pc.onicecandidate = e=>{ if(e.candidate) ws.send(`CANDIDATE|${peerId}|${remoteId}|${JSON.stringify(e.candidate)}`); };
      pc.ontrack = e=>{
        log(`Received track from ${key}`);
        const videoEl = key==='unity'? UnityVideo : PythonVideo;
        videoEl.srcObject = e.streams[0];
      };
      pc.ondatachannel = e=>setupDataChannel(e.channel, key);

      peerConnections[key]=pc;
      createOffer(key);
    }

    async function createOffer(key){
      const pc=peerConnections[key];
      const remoteId=receivers[key];
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      ws.send(`OFFER|${peerId}|${remoteId}|${JSON.stringify({type:'offer', sdp: pc.localDescription.sdp})}`);
      log(`Sent offer to ${key}`);
    }

    async function handleOffer(senderId, msg){
      const key=Object.keys(receivers).find(k=>receivers[k]===senderId); if(!key) return;
      if(!peerConnections[key]) createPeerConnection(key);
      const pc=peerConnections[key];
      const offerObj=JSON.parse(msg);
      await pc.setRemoteDescription({type:'offer', sdp: offerObj.sdp});
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      ws.send(`ANSWER|${peerId}|${senderId}|${JSON.stringify({type:'answer', sdp: pc.localDescription.sdp})}`);
      log(`Sent answer to ${key}`);
    }

    async function handleAnswer(senderId,msg){
      const key=Object.keys(receivers).find(k=>receivers[k]===senderId); if(!key) return;
      const pc=peerConnections[key];
      const ansObj=JSON.parse(msg);
      await pc.setRemoteDescription({type:'answer', sdp: ansObj.sdp});
      log(`Received answer from ${key}`);
    }

    async function handleCandidate(senderId,msg){
      const key=Object.keys(receivers).find(k=>receivers[k]===senderId); if(!key) return;
      const pc=peerConnections[key];
      const candObj=JSON.parse(msg);
      if(candObj.candidate) await pc.addIceCandidate(candObj);
    }

    function setupDataChannel(dc, key){
      dc.onopen=()=>log(`Data channel ${key} opened`);
      dc.onclose=()=>log(`Data channel ${key} closed`);
      dc.onmessage=e=>log(`Data from ${key}: ${e.data}`);
    }

    function disconnectAll(){
      Object.values(peerConnections).forEach(pc=>pc.close());
      Object.values(dataChannels).forEach(dc=>dc.close());
      peerConnections={}; dataChannels={};
      connectBtn.disabled = !localStream; disconnectBtn.disabled=true; sendDataBtn.disabled=true;
      UnityVideo.srcObject=null; PythonVideo.srcObject=null;
    }

    window.addEventListener('beforeunload', ()=>{
      if(ws && ws.readyState===WebSocket.OPEN) ws.send(`DISPOSE|${peerId}|ALL|Remove peer|0|false`);
      if(fileVideo.src.startsWith('blob:')) URL.revokeObjectURL(fileVideo.src);
    });
  </script>
</body>
</html>
