<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebRTC IP Camera Stream</title>
  <style>
    body { font-family: Arial; max-width: 800px; margin: 0 auto; padding: 20px; }
    video { width: 640px; height: 480px; background: #000; border: 1px solid #ccc; margin-bottom: 10px; }
    .status { font-family: monospace; background: #f7f7f7; border: 1px solid #ccc; padding: 10px; height: 200px; overflow-y: auto; }
  </style>
</head>
<body>
  <h2>IP Camera via WebRTC</h2>
  <video id="remoteVideo" autoplay playsinline></video>
  <div>
    <label>Peer ID:</label>
    <input type="text" id="peerId" value="IPCam-Client">
    <button id="connectBtn">Connect</button>
  </div>
  <h3>Status</h3>
  <div id="statusLog" class="status"></div>

  <script>
    const remoteVideo = document.getElementById('remoteVideo');
    const peerIdInput = document.getElementById('peerId');
    const connectBtn = document.getElementById('connectBtn');
    const statusLog = document.getElementById('statusLog');

    let ws, pc;

    function log(msg, error=false){
      const div=document.createElement('div');
      div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      if(error) div.style.color='red';
      statusLog.appendChild(div);
      statusLog.scrollTop=statusLog.scrollHeight;
      console.log(msg);
    }

    connectBtn.onclick = () => {
      const peerId = peerIdInput.value.trim();
      if(!peerId){ log('Enter Peer ID', true); return; }

      const protocol = location.protocol==='https:'?'wss://':'ws://';
      ws = new WebSocket(`${protocol}${location.host}`);

      ws.onopen = () => {
        log('Connected to signaling server');
        ws.send(`NEWPEER|${peerId}|ALL|Client ready|0|false`);

        pc = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});

        pc.ontrack = (event) => {
          log('Received remote track');
          remoteVideo.srcObject = event.streams[0];
        };

        pc.onicecandidate = (e) => {
          if(e.candidate){
            ws.send(`CANDIDATE|${peerId}|ALL|${JSON.stringify(e.candidate)}`);
          }
        };
      };

      ws.onmessage = async (event)=>{
        const [type, senderId, , content] = event.data.split('|');
        if(senderId===peerId) return;

        switch(type){
          case 'NEWPEER':
            // Create offer to new sender
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            ws.send(`OFFER|${peerId}|${senderId}|${JSON.stringify(offer)}`);
            log(`Sent offer to ${senderId}`);
            break;

          case 'OFFER':
            const offerObj = JSON.parse(content);
            await pc.setRemoteDescription(new RTCSessionDescription(offerObj));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            ws.send(`ANSWER|${peerId}|${senderId}|${JSON.stringify(answer)}`);
            log(`Answered offer from ${senderId}`);
            break;

          case 'ANSWER':
            const answerObj = JSON.parse(content);
            await pc.setRemoteDescription(new RTCSessionDescription(answerObj));
            log(`Received answer from ${senderId}`);
            break;

          case 'CANDIDATE':
            const cand = JSON.parse(content);
            await pc.addIceCandidate(new RTCIceCandidate(cand));
            log(`Added ICE candidate from ${senderId}`);
            break;

          case 'DISPOSE':
            log(`Peer ${senderId} disconnected`);
            break;
        }
      };
    };
  </script>
</body>
</html>
