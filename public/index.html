<!DOCTYPE html>
<html>
<head>
  <title>WebRTC File Stream</title>
</head>
<body>
  <h2>Upload video file and stream</h2>
  <input type="file" id="fileInput" accept="video/*" />
  <video id="localVideo" autoplay playsinline muted></video>

  <script>
    const ws = new WebSocket("wss://bytes.clear-trail.com/");
    let localStream;
    const peers = {};

    // 1. On page load connect to signaling server
    ws.onopen = () => {
      console.log("Connected to signaling server âœ…");
      ws.send(JSON.stringify({ type: "hello", role: "sender" }));
    };

    // 2. Handle incoming signaling messages
    ws.onmessage = async (event) => {
      const msg = JSON.parse(event.data);

      if (msg.type === "answer" && peers[msg.from]) {
        await peers[msg.from].setRemoteDescription({ type: "answer", sdp: msg.sdp });
      }

      if (msg.type === "ice-candidate" && peers[msg.from]) {
        try { await peers[msg.from].addIceCandidate(msg.candidate); }
        catch (err) { console.warn(err); }
      }

      if (msg.type === "request-offer" && msg.from && !peers[msg.from]) {
        console.log("Offer requested by:", msg.from);

        const pc = new RTCPeerConnection();
        peers[msg.from] = pc;

        // Add tracks from uploaded video
        if (localStream) {
          localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
        }

        pc.onicecandidate = (e) => {
          if (e.candidate) {
            ws.send(JSON.stringify({
              type: "ice-candidate",
              to: msg.from,
              candidate: e.candidate
            }));
          }
        };

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        ws.send(JSON.stringify({
          type: "offer",
          to: msg.from,
          sdp: offer.sdp
        }));
      }
    };

    // 3. File upload â†’ capture stream
    document.getElementById("fileInput").addEventListener("change", async (event) => {
      const file = event.target.files[0];
      if (!file) return;

      const video = document.getElementById("localVideo");
      video.src = URL.createObjectURL(file);
      await video.play();

      localStream = video.captureStream();

      // notify peers that sender is ready
      ws.send(JSON.stringify({ type: "broadcast", message: "sender-ready" }));
      console.log("Sender ready, streaming video ðŸŽ¥");
    });
  </script>
</body>
</html>
