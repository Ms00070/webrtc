<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Signaling Tester</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .video-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        video {
            width: 320px;
            height: 240px;
            background-color: #000;
            border: 1px solid #ccc;
        }
        .control-panel {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f8f8f8;
        }
        button {
            padding: 10px;
            cursor: pointer;
        }
        .status {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f0f0f0;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
        }
        .connected {
            color: green;
        }
        .disconnected {
            color: red;
        }
    </style>
</head>
<body>
  <h2>üåê SFU MP4 Streaming + Chat</h2>
  <input type="file" id="fileInput" accept="video/mp4" />
  <video id="video" controls autoplay muted></video>
 
  <div id="chatBox"></div>
  <input id="chatInput" placeholder="Type a message..." />
  <button onclick="sendChat()">Send</button>
 
  <script>
    const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
    const ws = new WebSocket(`${wsProtocol}//${location.host}`);
    const video = document.getElementById('video');
    const chatBox = document.getElementById('chatBox');
    let localStream;
    let peers = {};
 
    ws.onopen = () => {
      console.log("Connected to signaling server");
      ws.send(JSON.stringify({ type: 'join' }));
    };
 
    ws.onmessage = async (msg) => {
      const data = JSON.parse(msg.data);
      switch (data.type) {
        case 'offer': await handleOffer(data); break;
        case 'answer': await handleAnswer(data); break;
        case 'ice': if (peers[data.id]) peers[data.id].pc.addIceCandidate(data.candidate); break;
        case 'chat': chatBox.innerHTML += `<div><b>${data.id}:</b> ${data.message}</div>`; break;
      }
    };
 
    async function handleOffer(data) {
      const pc = createPeerConnection(data.id);
      peers[data.id] = { pc };
      await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      ws.send(JSON.stringify({ type: 'answer', answer, id: data.id }));
    }
 
    async function handleAnswer(data) {
      const pc = peers[data.id]?.pc;
      if (pc) await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
    }
 
    function createPeerConnection(id) {
      const pc = new RTCPeerConnection();
      pc.onicecandidate = (e) => {
        if (e.candidate)
          ws.send(JSON.stringify({ type: 'ice', candidate: e.candidate, id }));
      };
      pc.ontrack = (e) => {
        console.log("Receiving remote stream");
        video.srcObject = e.streams[0];
      };
      return pc;
    }
 
    document.getElementById('fileInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
 
      const videoURL = URL.createObjectURL(file);
      video.src = videoURL;
      await video.play();
 
      localStream = video.captureStream();
      const pc = new RTCPeerConnection();
      localStream.getTracks().forEach((t) => pc.addTrack(t, localStream));
      pc.onicecandidate = (e) => {
        if (e.candidate)
          ws.send(JSON.stringify({ type: 'ice', candidate: e.candidate, id: 'broadcaster' }));
      };
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      ws.send(JSON.stringify({ type: 'offer', offer, id: 'broadcaster' }));
    });
 
    function sendChat() {
      const msg = document.getElementById('chatInput').value.trim();
      if (!msg) return;
      ws.send(JSON.stringify({ type: 'chat', message: msg }));
      document.getElementById('chatInput').value = '';
    }
  </script>
</body>
</html>
