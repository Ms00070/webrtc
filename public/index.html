<!DOCTYPE html>
<html>
<head>
  <title>WebRTC MP4 Stream</title>
  <style>
    #log {
      border: 1px solid #ccc;
      padding: 10px;
      height: 200px;
      overflow-y: scroll;
      font-family: monospace;
      background: #f9f9f9;
    }
  </style>
</head>
<body>
  <h2>Upload MP4 and Stream</h2>
  <input type="file" id="fileInput" accept="video/mp4">
  <video id="localVideo" autoplay controls playsinline muted></video>
  <h3>Logs</h3>
  <div id="log"></div>
 
  <script>
    function logOnScreen(msg) {
      const logDiv = document.getElementById("log");
      logDiv.innerHTML += msg + "<br>";
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(msg);
    }
 
    const ws = new WebSocket("wss://bytes.clear-trail.com/");
    const peers = {};
    let localStream;
 
    ws.onopen = () => logOnScreen("Connected to custom WSS server");
 
    ws.onmessage = async (event) => {
      const msg = JSON.parse(event.data);
      logOnScreen("Received message: " + JSON.stringify(msg));
 
      if (msg.type === "answer" && peers[msg.from]) {
        await peers[msg.from].setRemoteDescription({ type: "answer", sdp: msg.sdp });
        logOnScreen(`Answer set from client ${msg.from}`);
      }
 
      if (msg.type === "ice-candidate" && peers[msg.from]) {
        try {
          await peers[msg.from].addIceCandidate(msg.candidate);
          logOnScreen(`ICE candidate added from client ${msg.from}`);
        } catch(e) {
          logOnScreen(`Error adding ICE candidate: ${e}`);
        }
      }
 
      if (msg.type === "request-offer" && msg.from && !peers[msg.from]) {
        const pc = new RTCPeerConnection();
        peers[msg.from] = pc;
        logOnScreen(`Creating PeerConnection for client ${msg.from}`);
 
        if (localStream) {
          localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
          logOnScreen("Added local video tracks to PeerConnection");
        }
 
        pc.onicecandidate = (e) => {
          if (e.candidate) {
            ws.send(JSON.stringify({ type: "ice-candidate", to: msg.from, candidate: e.candidate }));
            logOnScreen(`Sent ICE candidate to client ${msg.from}`);
          }
        }
 
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        ws.send(JSON.stringify({ type: "offer", to: msg.from, sdp: offer.sdp }));
        logOnScreen(`Sent offer to client ${msg.from}`);
      }
    };
 
    document.getElementById("fileInput").addEventListener("change", async (event) => {
      const file = event.target.files[0];
      if (!file) return;
 
      const video = document.getElementById("localVideo");
      video.src = URL.createObjectURL(file);
      await video.play();
      logOnScreen("Video loaded and playing");
 
      localStream = video.captureStream();
      logOnScreen("Captured stream from video");
 
      ws.send(JSON.stringify({ type: "broadcast", broadcast: true, message: "sender-ready" }));
      logOnScreen("Broadcasted sender-ready message");
    });
  </script>
</body>
</html>
 
