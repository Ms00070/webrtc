<script>
  // Replace localhost with your server URL if deployed
  const ws = new WebSocket("wss://bytes.clear-trail.com/");
  const peers = {};
  let localStream;

  ws.onopen = () => console.log("Connected to custom WSS server");

  ws.onmessage = async (event) => {
    const msg = JSON.parse(event.data);

    if (msg.type === "answer" && peers[msg.from]) {
      await peers[msg.from].setRemoteDescription({ type: "answer", sdp: msg.sdp });
    }

    if (msg.type === "ice-candidate" && peers[msg.from]) {
      try { await peers[msg.from].addIceCandidate(msg.candidate); } 
      catch(e){ console.warn(e) }
    }

    if (msg.type === "request-offer" && msg.from && !peers[msg.from]) {
      const pc = new RTCPeerConnection();
      peers[msg.from] = pc;

      if (localStream) localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      pc.onicecandidate = (e) => {
        if (e.candidate) ws.send(JSON.stringify({ type: "ice-candidate", to: msg.from, candidate: e.candidate }));
      }

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      ws.send(JSON.stringify({ type: "offer", to: msg.from, sdp: offer.sdp }));
    }
  };

  document.getElementById("fileInput").addEventListener("change", async (event) => {
    const file = event.target.files[0];
    if (!file) return;

    const video = document.getElementById("localVideo");
    video.src = URL.createObjectURL(file);
    await video.play();

    localStream = video.captureStream();

    ws.send(JSON.stringify({ type: "broadcast", broadcast: true, message: "sender-ready" }));
  });
</script>
